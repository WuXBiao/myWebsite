name: Deploy to Server

on:
  workflow_run:
    workflows: ["Frontend Blog - Build and Deploy"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ~/my-blog
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            
            # 拉取最新镜像
            echo "拉取最新镜像..."
            docker pull $DOCKER_USERNAME/my-personal-blog:latest
            
            # 停止并删除旧容器
            echo "停止旧容器..."
            docker stop my-personal-blog 2>/dev/null || true
            docker rm my-personal-blog 2>/dev/null || true
            
            # 启动新容器
            echo "启动新容器..."
            docker run -d \
              --name my-personal-blog \
              --restart always \
              -p 80:80 \
              -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf \
              -v $(pwd)/logs:/var/log/nginx \
              $DOCKER_USERNAME/my-personal-blog:latest
            
            # 检查容器状态
            echo "检查容器状态..."
            docker ps | grep my-personal-blog
            
            # 清理未使用的镜像
            echo "清理未使用的镜像..."
            docker image prune -f
            
            echo "部署完成！"
            
      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 等待容器启动
            sleep 10
            
            # 健康检查
            if curl -f http://localhost; then
              echo "✅ 部署成功！网站正常运行"
            else
              echo "❌ 部署失败！网站无法访问"
              exit 1
            fi
