name: Simple Deploy

on:
  workflow_run:
    workflows: ["Frontend Blog - Build and Deploy"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ~/my-blog
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "æ‹‰å–æœ€æ–°é•œåƒ..."
            docker pull $DOCKER_USERNAME/my-personal-blog:latest
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "åœæ­¢æ—§å®¹å™¨..."
            docker stop my-personal-blog 2>/dev/null || true
            docker rm my-personal-blog 2>/dev/null || true
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name my-personal-blog \
              --restart always \
              -p 80:80 \
              -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf \
              -v $(pwd)/logs:/var/log/nginx \
              $DOCKER_USERNAME/my-personal-blog:latest
            
            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "ç­‰å¾…å®¹å™¨å¯åŠ¨..."
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            echo "è¿›è¡Œå¥åº·æ£€æŸ¥..."
            if curl -f http://localhost; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼ç½‘ç«™æ­£å¸¸è¿è¡Œ"
              echo "ğŸŒ è®¿é—®åœ°å€: http://$(curl -s ifconfig.me)"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼ç½‘ç«™æ— æ³•è®¿é—®"
              docker logs my-personal-blog --tail=20
              exit 1
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"

      - name: Display deployment info
        run: |
          echo "âœ… éƒ¨ç½²å·²å®Œæˆï¼"
          echo "ğŸ“ æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—è¯·è®¿é—®: https://github.com/${{ github.repository }}/actions"
          echo "ğŸŒ ç½‘ç«™åœ°å€: http://ä½ çš„æœåŠ¡å™¨IP"
