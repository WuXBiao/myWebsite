name: Deploy with Notifications

on:
  workflow_run:
    workflows: ["Frontend Blog - Build and Deploy"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Log deployment start
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åšå®¢åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ”— æäº¤: ${{ github.sha }}"
          echo "â° æ—¶é—´: $(date)"

      - name: Deploy to server
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ~/my-blog
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            
            echo "æ‹‰å–æœ€æ–°é•œåƒ..."
            docker pull $DOCKER_USERNAME/my-personal-blog:latest
            
            echo "åœæ­¢æ—§å®¹å™¨..."
            docker stop my-personal-blog 2>/dev/null || true
            docker rm my-personal-blog 2>/dev/null || true
            
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name my-personal-blog \
              --restart always \
              -p 80:80 \
              -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf \
              -v $(pwd)/logs:/var/log/nginx \
              $DOCKER_USERNAME/my-personal-blog:latest
            
            sleep 10
            
            if curl -f http://localhost; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
              exit 1
            fi

      - name: Create deployment issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš€ éƒ¨ç½²å®Œæˆ - ' + new Date().toLocaleString('zh-CN'),
              body: `
            ## ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼
            
            **éƒ¨ç½²ä¿¡æ¯ï¼š**
            - ğŸ“… éƒ¨ç½²æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
            - ğŸ”— æäº¤å“ˆå¸Œï¼š\`${{ github.sha }}\`
            - ğŸŒ ç½‘ç«™åœ°å€ï¼šhttp://ä½ çš„æœåŠ¡å™¨IP
            - ğŸ“ å·¥ä½œæµï¼š[${{ github.workflow }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            **éƒ¨ç½²çŠ¶æ€ï¼š** âœ… æˆåŠŸ
            
            ---
            *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
              `,
              labels: ['deployment', 'success']
            })
        if: success()

      - name: Create deployment failure issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ éƒ¨ç½²å¤±è´¥ - ' + new Date().toLocaleString('zh-CN'),
              body: `
            ## âš ï¸ åšå®¢éƒ¨ç½²å¤±è´¥ï¼
            
            **éƒ¨ç½²ä¿¡æ¯ï¼š**
            - ğŸ“… éƒ¨ç½²æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
            - ğŸ”— æäº¤å“ˆå¸Œï¼š\`${{ github.sha }}\`
            - ğŸ“ å·¥ä½œæµï¼š[${{ github.workflow }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            **éƒ¨ç½²çŠ¶æ€ï¼š** âŒ å¤±è´¥
            
            **å¯èƒ½çš„åŸå› ï¼š**
            - æœåŠ¡å™¨è¿æ¥é—®é¢˜
            - Docker é•œåƒæ‹‰å–å¤±è´¥
            - å®¹å™¨å¯åŠ¨å¤±è´¥
            - å¥åº·æ£€æŸ¥æœªé€šè¿‡
            
            **è§£å†³æ–¹æ¡ˆï¼š**
            1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å’Œç½‘ç»œè¿æ¥
            2. æŸ¥çœ‹ [GitHub Actions æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            3. æ‰‹åŠ¨ç™»å½•æœåŠ¡å™¨æ£€æŸ¥ Docker çŠ¶æ€
            4. é‡æ–°è¿è¡Œéƒ¨ç½²å·¥ä½œæµ
            
            ---
            *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
              `,
              labels: ['deployment', 'failure', 'bug']
            })
        if: failure()
