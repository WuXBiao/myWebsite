name: Frontend Blog - Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'my-blog/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push frontend blog
        uses: docker/build-push-action@v4
        with:
          context: ./my-blog
          file: ./my-blog/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/my-personal-blog:${{ github.sha }}
          build-args: |
            BUILD_VERSION=${{ github.sha }}
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/my-personal-blog:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/my-personal-blog:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Log deployment start
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯åšå®¢åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ”— æäº¤: ${{ github.sha }}"
          echo "â° æ—¶é—´: $(date)"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            cd ~/my-blog
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export IMAGE_TAG=${{ github.sha }}
            
            echo "========== éƒ¨ç½²ä¿¡æ¯ =========="
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "Docker ç”¨æˆ·å: $DOCKER_USERNAME"
            echo "é•œåƒæ ‡ç­¾: $IMAGE_TAG"
            echo "æ—¶é—´: $(date)"
            echo ""
            
            echo "========== æ£€æŸ¥ç¯å¢ƒ =========="
            echo "Docker ç‰ˆæœ¬:"
            docker --version
            echo ""
            echo "Docker é•œåƒåˆ—è¡¨:"
            docker images | head -10
            echo ""
            
            echo "========== æ‹‰å–é•œåƒ =========="
            echo "æ‹‰å–é•œåƒ: $DOCKER_USERNAME/my-personal-blog:$IMAGE_TAG"
            if docker pull $DOCKER_USERNAME/my-personal-blog:$IMAGE_TAG; then
              echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
            else
              echo "âŒ é•œåƒæ‹‰å–å¤±è´¥"
              exit 1
            fi
            echo ""
            
            echo "========== åœæ­¢æ—§å®¹å™¨ =========="
            if docker stop my-personal-blog 2>/dev/null; then
              echo "âœ… æ—§å®¹å™¨å·²åœæ­¢"
            else
              echo "âš ï¸  æ—§å®¹å™¨ä¸å­˜åœ¨æˆ–å·²åœæ­¢"
            fi
            
            if docker rm my-personal-blog 2>/dev/null; then
              echo "âœ… æ—§å®¹å™¨å·²åˆ é™¤"
            else
              echo "âš ï¸  æ—§å®¹å™¨ä¸å­˜åœ¨"
            fi
            echo ""
            
            echo "========== æ£€æŸ¥è¯ä¹¦æ–‡ä»¶ =========="
            if [ -f /etc/ssl/certs/www.yyi77.top.pem ]; then
              echo "âœ… è¯ä¹¦æ–‡ä»¶å­˜åœ¨: /etc/ssl/certs/www.yyi77.top.pem"
            else
              echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: /etc/ssl/certs/www.yyi77.top.pem"
            fi
            
            if [ -f /etc/ssl/certs/www.yyi77.top.key ]; then
              echo "âœ… å¯†é’¥æ–‡ä»¶å­˜åœ¨: /etc/ssl/certs/www.yyi77.top.key"
            else
              echo "âŒ å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: /etc/ssl/certs/www.yyi77.top.key"
            fi
            echo ""
            
            echo "========== æ£€æŸ¥ Nginx é…ç½® =========="
            if [ -f nginx.conf ]; then
              echo "âœ… Nginx é…ç½®æ–‡ä»¶å­˜åœ¨"
              echo "é…ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
              head -20 nginx.conf
            else
              echo "âŒ Nginx é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            echo ""
            
            echo "========== åˆ›å»º Docker ç½‘ç»œ =========="
            if docker network create app-network 2>/dev/null; then
              echo "âœ… Docker ç½‘ç»œå·²åˆ›å»º"
            else
              echo "âš ï¸  Docker ç½‘ç»œå·²å­˜åœ¨"
            fi
            echo ""
            
            echo "========== å¯åŠ¨æ–°å®¹å™¨ =========="
            CONTAINER_ID=$(docker run -d \
              --name my-personal-blog \
              --restart always \
              --network app-network \
              -p 80:80 \
              -p 443:443 \
              -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf \
              -v $(pwd)/logs:/var/log/nginx \
              -v /etc/ssl/certs/www.yyi77.top.pem:/etc/nginx/ssl/www.yyi77.top.pem:ro \
              -v /etc/ssl/certs/www.yyi77.top.key:/etc/nginx/ssl/www.yyi77.top.key:ro \
              $DOCKER_USERNAME/my-personal-blog:$IMAGE_TAG)
            
            if [ -n "$CONTAINER_ID" ]; then
              echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼ŒID: $CONTAINER_ID"
            else
              echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
              exit 1
            fi
            echo ""
            
            echo "========== ç­‰å¾…å®¹å™¨å°±ç»ª =========="
            sleep 10
            
            echo "========== æ£€æŸ¥å®¹å™¨çŠ¶æ€ =========="
            docker ps | grep my-personal-blog
            echo ""
            
            echo "========== æ£€æŸ¥å®¹å™¨æ—¥å¿— =========="
            echo "æœ€è¿‘çš„å®¹å™¨æ—¥å¿—:"
            docker logs --tail 20 my-personal-blog || echo "âš ï¸  æ— æ³•è·å–å®¹å™¨æ—¥å¿—"
            echo ""
            
            echo "========== å¥åº·æ£€æŸ¥ =========="
            if curl -f http://localhost 2>/dev/null; then
              echo "âœ… HTTP å¥åº·æ£€æŸ¥æˆåŠŸ"
            else
              echo "âš ï¸  HTTP å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯• HTTPS..."
              if curl -f -k https://localhost 2>/dev/null; then
                echo "âœ… HTTPS å¥åº·æ£€æŸ¥æˆåŠŸ"
              else
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                echo "å®¹å™¨æ—¥å¿—:"
                docker logs my-personal-blog
                exit 1
              fi
            fi
            echo ""
            echo "========== éƒ¨ç½²å®Œæˆ =========="
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"

      - name: Deployment success notification
        run: |
          echo "ğŸ‰ å‰ç«¯åšå®¢éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          echo "ğŸŒ ç½‘ç«™åœ°å€: http://ä½ çš„æœåŠ¡å™¨IP"
          echo "ğŸ“ å·¥ä½œæµ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        if: success()

      - name: Deployment failure notification
        run: |
          echo "âŒ å‰ç«¯åšå®¢éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          echo "ğŸ“ å·¥ä½œæµ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "å¯èƒ½çš„åŸå› ï¼š"
          echo "- æœåŠ¡å™¨è¿æ¥é—®é¢˜"
          echo "- Docker é•œåƒæ‹‰å–å¤±è´¥"
          echo "- å®¹å™¨å¯åŠ¨å¤±è´¥"
          echo "- å¥åº·æ£€æŸ¥æœªé€šè¿‡"
        if: failure()
