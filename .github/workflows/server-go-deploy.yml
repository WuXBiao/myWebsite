name: Go Server - Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'server-go/**'
      - '.github/workflows/server-go-deploy.yml'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Go server
        uses: docker/build-push-action@v4
        with:
          context: ./server-go
          file: ./server-go/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/my-go-server:${{ github.sha }}
          build-args: |
            BUILD_VERSION=${{ github.sha }}
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/my-go-server:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/my-go-server:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Log deployment start
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² Go æœåŠ¡å™¨åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ”— æäº¤: ${{ github.sha }}"
          echo "â° æ—¶é—´: $(date)"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ~/server-go
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export IMAGE_TAG=${{ github.sha }}
            
            echo "æ‹‰å–é•œåƒ: $DOCKER_USERNAME/my-go-server:$IMAGE_TAG"
            docker pull $DOCKER_USERNAME/my-go-server:$IMAGE_TAG
            
            echo "åœæ­¢æ—§å®¹å™¨..."
            docker stop my-go-server 2>/dev/null || true
            docker rm my-go-server 2>/dev/null || true
            
            echo "å‡†å¤‡ä¸Šä¼ ç›®å½•..."
            mkdir -p $(pwd)/uploads
            chmod 755 $(pwd)/uploads
            
            echo "åˆ›å»º Docker ç½‘ç»œ..."
            docker network create app-network 2>/dev/null || true
            
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name my-go-server \
              --restart always \
              --network app-network \
              -p 8080:8080 \
              -v $(pwd)/uploads:/app/uploads \
              -v /etc/ssl/www.yyi77.top.pem:/etc/ssl/www.yyi77.top.pem:ro \
              -v /etc/ssl/www.yyi77.top.key:/etc/ssl/www.yyi77.top.key:ro \
              $DOCKER_USERNAME/my-go-server:$IMAGE_TAG
            
            sleep 10
            
            if curl -f http://localhost:8080/api/health; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
              exit 1
            fi

      - name: Deployment success notification
        run: |
          echo "ğŸ‰ Go æœåŠ¡å™¨éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          echo "ğŸŒ æœåŠ¡åœ°å€: http://ä½ çš„æœåŠ¡å™¨IP:8080"
          echo "ğŸ“ å·¥ä½œæµ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        if: success()

      - name: Deployment failure notification
        run: |
          echo "âŒ Go æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          echo "ğŸ“ å·¥ä½œæµ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "å¯èƒ½çš„åŸå› ï¼š"
          echo "- æœåŠ¡å™¨è¿æ¥é—®é¢˜"
          echo "- Docker é•œåƒæ‹‰å–å¤±è´¥"
          echo "- å®¹å™¨å¯åŠ¨å¤±è´¥"
          echo "- å¥åº·æ£€æŸ¥æœªé€šè¿‡"
        if: failure()
